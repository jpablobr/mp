#!/usr/bin/env bash

set -e

ctags --version >/dev/null 2>&1 || {
    echo "ctags not found or too old." 1>&2
    exit 1
}

gemset-tags(){
    local RPATH=`echo $GEM_PATH | cut -d: -f1`
    local RUBYALIAS='/.*alias(_method)?[[:space:]]+:([[:alnum:]_=!?]+),?[[:space:]]+:([[:alnum:]_=!]+)/\\2/f/'

    find $RPATH -type f -name '*.rb' | ctags -e \
        --verbose=yes \
        -L -
}
        # --tag-relative=yes \
        # --totals=yes \
        # --extra=+f \
        # --fields=+iaS \
        # --regex-ruby="$RUBYALIAS" "$@" \

project-tags(){
    find . -type f -name '*.rb' | ctags -e \
        --verbose=yes \
        --tag-relative=yes \
        --totals=yes \
        -L -
}

if [[ "$1" == "h" ]]; then
	  cat <<- -EOF-
Build an emacs "TAGS" file in current directory
based on the projects rvm gemset.
Requires exuberant ctags.

Usage: rtags [<options>]
$ rtags g
for building TAGS from the project gemset
$ rctags p
for building TAGS only from the project.
-EOF-
elif [[ "$1" == "g" ]]; then
    gemset-tags
elif [[ "$1" == "p" ]]; then
    project-tags
fi

exit 0