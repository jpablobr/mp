#!/usr/bin/env bash
# Build an emacs "TAGS" file in current directory
# based on the projects rvm gemset.
# Requires exuberant ctags.
#
# Usage: ctags-ruby [<options>]
# Any <options> provided are passed to `ctags`

set -e

ctags --version >/dev/null 2>&1 || {
    echo "ctags not found or too old." 1>&2
    exit 1
}

RPATH=`echo $GEM_PATH | cut -d: -f1`
RUBYALIAS='/.*alias(_method)?[[:space:]]+:([[:alnum:]_=!?]+),?[[:space:]]+:([[:alnum:]_=!]+)/\\2/f/'

find $RPATH -type f -name '*.rb' | ctags -e \
    --verbose=yes \
    --tag-relative=yes \
    --totals=yes \
    --extra=+f \
    --fields=+iaS \
    --regex-ruby="$RUBYALIAS" "$@" \
    -L -

exit 0
